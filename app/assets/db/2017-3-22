{
  "noteData": "<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@h1</span>-基于Nodejs的文件服务器\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@url</span>-[https://github.com/gemuandyou/node-file-server]Github项目地址\n\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@h2</span>-构建项目\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@ol</span>-(#安装gulp#根目录创建gulpfile.js文件#运行gulp，生成node_modules目录#初始化npm，生成package.json)\\\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@tab</span>-<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@code</span>-basis-@[&gt;npm install -g gulp]@<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@code</span>-basis-@[&gt;gulp]@<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@code</span>-basis-@[&gt;npm init]@\n\n\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@h2</span>-进一步整理项目结构\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@tab</span>-<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@img</span>-[app/assets/db/img/1490152695130.png] &lt;br&gt;\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;安装 <span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@fc</span>-blue-<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\">&gt;</span>require-dir  node模块，提供加载目录功能\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@code</span>-basis-@[&gt;npm install require-dir --save]@\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;安装 <span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@fc</span>-blue-<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\">&gt;</span>browser-sync node模块，提供服务器功能\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@code</span>-basis-@[&gt;npm install browser-sync --save]@\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;安装 <span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@fc</span>-blue-<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\">&gt;</span>formidable  node模块，提供表单相关服务 \n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@code</span>-basis-@[&gt;npm install formidable --save]@\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;gulpfile.js\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span><span style=\"color:#ffc66d;\">requireDir&#32;</span>=&#32;<span style=\"color:#ffc66d;\">require</span>(<span style=\"color:#6a8759;\">'require-dir'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#ffc66d;\">requireDir</span>(<span style=\"color:#6a8759;\">'./gulp'</span>)<span style=\"color:#cc7832;\">;</span></pre>]@ \n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;server.js\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#629755;font-style:italic;\">/**<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*&#32;Created&#32;by&#32;Gemu&#32;on&#32;2017/3/22.<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*/<br></span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>gulp&#32;=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'gulp'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span><span style=\"color:#ffc66d;\">browserSync&#32;</span>=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'browser-sync'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span><span style=\"color:#9876aa;\">uri&#32;</span>=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'./uri'</span>)<span style=\"color:#cc7832;\">;<br></span>gulp.<span style=\"color:#9876aa;\">task</span>(<span style=\"color:#6a8759;\">'server'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>()&#32;{<br>&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">browserSync</span>.<span style=\"color:#ffc66d;\">init</span>({<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#9876aa;\">browser</span>:&#32;<span style=\"color:#6a8759;\">'chrome'</span><span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">server</span>:&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#9876aa;\">baseDir</span>:&#32;<span style=\"color:#6a8759;\">'src'</span><span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">middleware</span>:&#32;<span style=\"color:#9876aa;\">uri<br></span><span style=\"color:#9876aa;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;})<span style=\"color:#cc7832;\">;<br></span>})<span style=\"color:#cc7832;\">;</span></pre>]@ \n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;uri.js\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#cc7832;font-weight:bold;\">const&#32;</span>formidable&#32;=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">\"formidable\"</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;font-weight:bold;\">const&#32;</span>fs&#32;=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'fs'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;font-weight:bold;\">const&#32;</span><span style=\"color:#9876aa;\">file&#32;</span>=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'./file'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\"><br></span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span><span style=\"color:#ffc66d;\">getChildrenFile&#32;</span>=&#32;<span style=\"color:#cc7832;font-weight:bold;\">function</span>(path)&#32;{<br>&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(fs.existsSync(path))&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>childrens&#32;=&#32;[]<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>childrens&#32;=&#32;fs.readdirSync(path)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">return&#32;</span>childrens<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>}<br>}<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\"><br></span>module.<span style=\"color:#ffc66d;\">exports&#32;</span>=&#32;[{<br>&#32;&#32;&#32;&#32;<span style=\"color:#808080;\">//&#32;处理表单上传<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">route</span>:&#32;<span style=\"color:#6a8759;\">\"/api/uploadForm/\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#808080;\">//&#32;complete-route<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#ffc66d;\">handle</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(req<span style=\"color:#cc7832;\">,&#32;</span>res<span style=\"color:#cc7832;\">,&#32;</span>next)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>form&#32;=&#32;<span style=\"color:#cc7832;font-weight:bold;\">new&#32;</span>formidable.<span style=\"color:#9876aa;\">IncomingForm</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>form.<span style=\"color:#ffc66d;\">parse</span>(req<span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(err<span style=\"color:#cc7832;\">,&#32;</span>fields<span style=\"color:#cc7832;\">,&#32;</span>files)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(files&#32;&amp;&amp;&#32;fields.<span style=\"color:#9876aa;\">filePath&#32;</span>&amp;&amp;&#32;files.<span style=\"color:#9876aa;\">file</span>)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>filePath&#32;=&#32;<span style=\"color:#9876aa;\">file</span>.<span style=\"color:#ffc66d;\">writeFileFromForm</span>(fields.<span style=\"color:#9876aa;\">filePath</span><span style=\"color:#cc7832;\">,&#32;</span>files.<span style=\"color:#9876aa;\">file</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.setHeader(<span style=\"color:#6a8759;\">'Content-Type'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'text/plain;&#32;charset=utf-8'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.<span style=\"color:#ffc66d;\">write</span>(filePath<span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'utf-8'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">end</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>}<br>}<span style=\"color:#cc7832;\">,&#32;</span>{<br>&#32;&#32;&#32;&#32;<span style=\"color:#808080;\">//&#32;处理普通参数上传<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">route</span>:&#32;<span style=\"color:#6a8759;\">\"/api/upload/\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#808080;\">//&#32;complete-route<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#ffc66d;\">handle</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(req<span style=\"color:#cc7832;\">,&#32;</span>res<span style=\"color:#cc7832;\">,&#32;</span>next)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>body&#32;=&#32;[]<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>req.<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'data'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(chunk){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;body.<span style=\"color:#ffc66d;\">push</span>(chunk)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>req.<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'end'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;body&#32;=&#32;Buffer.<span style=\"color:#ffc66d;\">concat</span>(body).<span style=\"color:#ffc66d;\">toString</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>parts&#32;=&#32;body.<span style=\"color:#ffc66d;\">split</span>(<span style=\"color:#6a8759;\">'&amp;'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>params&#32;=&#32;{}<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">for&#32;</span>(<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>i&#32;<span style=\"color:#cc7832;font-weight:bold;\">in&#32;</span>parts)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>param&#32;=&#32;parts[i]<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>kv&#32;=&#32;param.<span style=\"color:#ffc66d;\">split</span>(<span style=\"color:#6a8759;\">'='</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>params[kv[<span style=\"color:#6897bb;\">0</span>]]&#32;=&#32;kv[<span style=\"color:#6897bb;\">1</span>]<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>buffer&#32;=&#32;<span style=\"color:#cc7832;font-weight:bold;\">new&#32;</span>Buffer(params[<span style=\"color:#6a8759;\">'fileBuffer'</span>]<span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'hex'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>filePath&#32;=&#32;<span style=\"color:#9876aa;\">file</span>.<span style=\"color:#ffc66d;\">writeFile</span>(<span style=\"color:#ffc66d;\">decodeURI</span>(params[<span style=\"color:#6a8759;\">'filePath'</span>])<span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#ffc66d;\">decodeURI</span>(params[<span style=\"color:#6a8759;\">'fileName'</span>])<span style=\"color:#cc7832;\">,&#32;</span>buffer)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.setHeader(<span style=\"color:#6a8759;\">'Content-Type'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'text/plain;&#32;charset=utf-8'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.<span style=\"color:#ffc66d;\">write</span>(filePath<span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'utf-8'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.<span style=\"color:#ffc66d;\">end</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>}<br>}<span style=\"color:#cc7832;\">,&#32;</span>{<br>&#32;&#32;&#32;&#32;<span style=\"color:#808080;\">//&#32;资源列表预览<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">route</span>:&#32;<span style=\"color:#6a8759;\">\"/assetsStruct\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#808080;\">//&#32;fuzzy-route&#32;e.g.&#32;=&gt;&#32;/assets/../..<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#ffc66d;\">handle</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(req<span style=\"color:#cc7832;\">,&#32;</span>res<span style=\"color:#cc7832;\">,&#32;</span>next)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>path&#32;=&#32;<span style=\"color:#6a8759;\">'src/assets'&#32;</span>+&#32;req.url<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>stats&#32;=&#32;fs.statSync(<span style=\"color:#ffc66d;\">decodeURI</span>(path))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(stats.isDirectory())&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>files&#32;=&#32;<span style=\"color:#ffc66d;\">getChildrenFile</span>(<span style=\"color:#ffc66d;\">decodeURI</span>(path))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(files)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.setHeader(<span style=\"color:#6a8759;\">'Content-Type'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'application/json;&#32;charset=utf-8'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.<span style=\"color:#ffc66d;\">write</span>(<span style=\"color:#9876aa;\">JSON</span>.<span style=\"color:#ffc66d;\">stringify</span>(files).<span style=\"color:#ffc66d;\">toString</span>())<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}&#32;<span style=\"color:#cc7832;font-weight:bold;\">else&#32;</span>{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">write</span>(<span style=\"color:#9876aa;\">JSON</span>.<span style=\"color:#ffc66d;\">stringify</span>(<span style=\"color:#6a8759;\">\"[]\"</span>).<span style=\"color:#ffc66d;\">toString</span>())<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(stats.isFile())&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.setHeader(<span style=\"color:#6a8759;\">'Content-Type'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">'application/json;&#32;charset=utf-8'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.<span style=\"color:#ffc66d;\">write</span>(<span style=\"color:#9876aa;\">JSON</span>.<span style=\"color:#ffc66d;\">stringify</span>({<span style=\"color:#9876aa;\">file</span>:&#32;<span style=\"color:#6a8759;\">'/assets'&#32;</span>+&#32;req.url}).<span style=\"color:#ffc66d;\">toString</span>())<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">end</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>}<br>}<span style=\"color:#cc7832;\">,&#32;</span>{<br>&#32;&#32;&#32;&#32;<span style=\"color:#808080;\">//&#32;资源访问<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">route</span>:&#32;<span style=\"color:#6a8759;\">\"/assets\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#808080;\">//&#32;fuzzy-route&#32;e.g.&#32;=&gt;&#32;/assets/../..<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#ffc66d;\">handle</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(req<span style=\"color:#cc7832;\">,&#32;</span>res<span style=\"color:#cc7832;\">,&#32;</span>next)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;next()<span style=\"color:#cc7832;\">;&#32;</span><span style=\"color:#808080;\">//&#32;返回资源<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;res.end();&#32;//&#32;中断资源请求，不反回资源<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span>}<br>}<span style=\"color:#cc7832;\">,&#32;</span>{<br>&#32;&#32;&#32;&#32;<span style=\"color:#808080;\">//&#32;资源下载<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">route</span>:&#32;<span style=\"color:#6a8759;\">\"/download/assets\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#808080;\">//&#32;fuzzy-route&#32;e.g.&#32;=&gt;&#32;/assets/../..<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#ffc66d;\">handle</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(req<span style=\"color:#cc7832;\">,&#32;</span>res<span style=\"color:#cc7832;\">,&#32;</span>next)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>path&#32;=&#32;req.url<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>fileName&#32;=&#32;path.<span style=\"color:#ffc66d;\">substring</span>(path.<span style=\"color:#ffc66d;\">lastIndexOf</span>(<span style=\"color:#6a8759;\">'/'</span>)&#32;+&#32;<span style=\"color:#6897bb;\">1</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>filePath&#32;=&#32;<span style=\"color:#6a8759;\">'src/assets'&#32;</span>+&#32;path<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>stats&#32;=&#32;fs.statSync(<span style=\"color:#ffc66d;\">decodeURI</span>(filePath))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(stats.isFile())&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.setHeader(<span style=\"color:#6a8759;\">\"Content-type\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">\"application/octet-stream\"</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>res.setHeader(<span style=\"color:#6a8759;\">\"Content-Disposition\"</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#6a8759;\">\"attachment;filename=\"</span>+<span style=\"color:#ffc66d;\">encodeURI</span>(fileName))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>filestream&#32;=&#32;fs.createReadStream(<span style=\"color:#ffc66d;\">decodeURI</span>(filePath))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>filestream.<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'data'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(chunk)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">write</span>(chunk)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>filestream.<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'end'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>()&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">end</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}&#32;<span style=\"color:#cc7832;font-weight:bold;\">else&#32;</span>{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">end</span>()<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;}<br>}]<span style=\"color:#cc7832;\">;</span></pre>]@ \n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-.&amp;nbsp;file.js\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#cc7832;font-weight:bold;\">const&#32;</span>fs&#32;=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'fs'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;font-weight:bold;\">const&#32;</span>path&#32;=&#32;<span style=\"color:#9876aa;\">require</span>(<span style=\"color:#6a8759;\">'path'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\"><br></span><span style=\"color:#629755;font-style:italic;\">/**<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*&#32;node创建指定文件夹结构。递归创建文件夹<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*&#32;reference<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*&#32;</span><span style=\"color:#629755;font-weight:bold;font-style:italic;\">@param&#32;</span><span style=\"color:#629755;font-style:italic;\">dirpath<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*&#32;</span><span style=\"color:#629755;font-weight:bold;font-style:italic;\">@param&#32;</span><span style=\"color:#629755;font-style:italic;\">dirname<br></span><span style=\"color:#629755;font-style:italic;\">&#32;*/<br></span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span><span style=\"color:#ffc66d;\">mkdirs&#32;</span>=&#32;<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(dirpath<span style=\"color:#cc7832;\">,&#32;</span>dirname){<br>&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if</span>(<span style=\"color:#cc7832;font-weight:bold;\">typeof&#32;</span>dirname&#32;===&#32;<span style=\"color:#6a8759;\">\"undefined\"</span>){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if</span>(fs.existsSync(dirpath)){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">return</span><span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<span style=\"color:#cc7832;font-weight:bold;\">else</span>{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">mkdirs</span>(dirpath<span style=\"color:#cc7832;\">,</span>path.dirname(dirpath))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;}<span style=\"color:#cc7832;font-weight:bold;\">else</span>{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if</span>(dirname&#32;!==&#32;path.dirname(dirpath)){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">mkdirs</span>(dirpath)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">return</span><span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if</span>(fs.existsSync(dirname)){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs.mkdirSync(dirpath)<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<span style=\"color:#cc7832;font-weight:bold;\">else</span>{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">mkdirs</span>(dirname<span style=\"color:#cc7832;\">,</span>path.dirname(dirname))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>fs.mkdirSync(dirpath)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;}<br>}<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\"><br></span>module.<span style=\"color:#ffc66d;\">exports&#32;</span>=&#32;{<br>&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">writeFileFromForm</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function</span>(filePath<span style=\"color:#cc7832;\">,&#32;</span>file)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filePath&#32;=&#32;<span style=\"color:#6a8759;\">'src/assets/'&#32;</span>+&#32;filePath<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(filePath.<span style=\"color:#ffc66d;\">lastIndexOf</span>(<span style=\"color:#6a8759;\">'/'</span>)&#32;!=&#32;filePath.<span style=\"color:#9876aa;\">length&#32;</span>-&#32;<span style=\"color:#6897bb;\">1</span>)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filePath&#32;+=&#32;<span style=\"color:#6a8759;\">'/'</span><span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">mkdirs</span>(filePath)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>fs.<span style=\"color:#ffc66d;\">writeFile</span>(<span style=\"color:#ffc66d;\">decodeURI</span>(filePath&#32;+&#32;file.<span style=\"color:#9876aa;\">name</span>)<span style=\"color:#cc7832;\">,&#32;</span>fs.readFileSync(file.<span style=\"color:#9876aa;\">path</span>))<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>filePath&#32;=&#32;filePath.<span style=\"color:#ffc66d;\">substring</span>(<span style=\"color:#6897bb;\">3</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">return&#32;</span>filePath&#32;+&#32;file.<span style=\"color:#9876aa;\">name</span><span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>}<span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span><span style=\"color:#ffc66d;\">writeFile</span>:&#32;<span style=\"color:#cc7832;font-weight:bold;\">function</span>(filePath<span style=\"color:#cc7832;\">,&#32;</span>fileName<span style=\"color:#cc7832;\">,&#32;</span>fileBuffer)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filePath&#32;=&#32;<span style=\"color:#6a8759;\">'src/assets/'&#32;</span>+&#32;filePath<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(filePath.<span style=\"color:#ffc66d;\">lastIndexOf</span>(<span style=\"color:#6a8759;\">'/'</span>)&#32;!=&#32;filePath.<span style=\"color:#9876aa;\">length&#32;</span>-&#32;<span style=\"color:#6897bb;\">1</span>)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filePath&#32;+=&#32;<span style=\"color:#6a8759;\">'/'</span><span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#ffc66d;\">mkdirs</span>(filePath)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>fs.<span style=\"color:#ffc66d;\">writeFile</span>(<span style=\"color:#ffc66d;\">decodeURI</span>(filePath&#32;+&#32;fileName)<span style=\"color:#cc7832;\">,&#32;</span>fileBuffer)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>filePath&#32;=&#32;filePath.<span style=\"color:#ffc66d;\">substring</span>(<span style=\"color:#6897bb;\">3</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">return&#32;</span>filePath&#32;+&#32;fileName<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>}<br>}<span style=\"color:#cc7832;\">;</span></pre>]@ \n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-整理过后的目录结构\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@img</span>-[app/assets/db/img/1490172016496.png] \n\n\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@h2</span>-远程调用接口上传文件方式\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@tab</span>-<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-html页面\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#e8bf6a;\">&lt;input&#32;</span><span style=\"color:#bababa;\">type=</span><span style=\"color:#a5c261;\">\"text\"&#32;</span><span style=\"color:#bababa;\">ng-model=</span><span style=\"color:#a5c261;\">\"filePath\"&#32;</span><span style=\"color:#bababa;\">class=</span><span style=\"color:#a5c261;\">\"form-control\"&#32;</span><span style=\"color:#bababa;\">placeholder=</span><span style=\"color:#a5c261;\">\"上传文件夹路径\"</span><span style=\"color:#e8bf6a;\">&gt;<br></span><span style=\"color:#e8bf6a;\">&lt;div&#32;</span><span style=\"color:#bababa;\">class=</span><span style=\"color:#a5c261;\">\"btn&#32;btn-primary\"&#32;</span><span style=\"color:#bababa;\">ng-click=</span><span style=\"color:#a5c261;\">\"testUpload()\"</span><span style=\"color:#e8bf6a;\">&gt;&lt;i&#32;</span><span style=\"color:#bababa;\">class=</span><span style=\"color:#a5c261;\">\"fa&#32;fa-plus\"</span><span style=\"color:#e8bf6a;\">&gt;&lt;/i&gt;&#32;</span>上传图片<span style=\"color:#e8bf6a;\">&lt;/div&gt;<br></span><span style=\"color:#e8bf6a;\">&lt;form&#32;</span><span style=\"color:#bababa;\">enctype=</span><span style=\"color:#a5c261;\">\"multipart/form-data\"&#32;</span><span style=\"color:#bababa;\">method=</span><span style=\"color:#a5c261;\">\"post\"&#32;</span><span style=\"color:#bababa;\">id=</span><span style=\"color:#a5c261;\">\"upload-form\"&#32;</span><span style=\"color:#bababa;\">hidden</span><span style=\"color:#e8bf6a;\">&gt;<br></span><span style=\"color:#e8bf6a;\">&#32;&#32;&#32;&#32;&lt;input&#32;</span><span style=\"color:#bababa;\">type=</span><span style=\"color:#a5c261;\">\"text\"&#32;</span><span style=\"color:#bababa;\">name=</span><span style=\"color:#a5c261;\">\"filePath\"&#32;</span><span style=\"color:#bababa;\">ng-model=</span><span style=\"color:#a5c261;\">\"filePath\"</span><span style=\"color:#e8bf6a;\">&gt;&lt;br&gt;<br></span><span style=\"color:#e8bf6a;\">&#32;&#32;&#32;&#32;&lt;input&#32;</span><span style=\"color:#bababa;\">type=</span><span style=\"color:#a5c261;\">\"file\"&#32;</span><span style=\"color:#bababa;\">name=</span><span style=\"color:#a5c261;\">\"file\"&#32;</span><span style=\"color:#bababa;\">multiple=</span><span style=\"color:#a5c261;\">\"multiple\"&#32;</span><span style=\"color:#bababa;\">id=</span><span style=\"color:#a5c261;\">\"upload-file\"</span><span style=\"color:#e8bf6a;\">&gt;&lt;br&gt;<br></span><span style=\"color:#e8bf6a;\">&lt;/form&gt;</span></pre>]@ \\\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-js\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#ffc66d;\">$</span>(<span style=\"color:#6a8759;\">'#upload-file'</span>).<span style=\"color:#ffc66d;\">change</span>(<span style=\"color:#ffc66d;font-weight:bold;\">function</span>()&#32;{<br>&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>formData&#32;=&#32;<span style=\"color:#cc7832;font-weight:bold;\">new&#32;</span>FormData($(&#32;<span style=\"color:#6a8759;\">\"#upload-form\"&#32;</span>)[<span style=\"color:#6897bb;\">0</span>])<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>$http({<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#9876aa;\">url</span>:&#32;<span style=\"color:#6a8759;\">'/testupload'</span><span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">method</span>:&#32;<span style=\"color:#6a8759;\">'post'</span><span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">data</span>:&#32;formData<span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">headers</span>:&#32;{<span style=\"color:#6a8759;\">'Content-Type'</span>:&#32;undefined}<span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">transformRequest</span>:&#32;angular.<span style=\"color:#9876aa;\">identity<br></span><span style=\"color:#9876aa;\">&#32;&#32;&#32;&#32;</span>}).<span style=\"color:#ffc66d;\">then</span>(<span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(resp)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if&#32;</span>(resp.<span style=\"color:#9876aa;\">status&#32;</span>===&#32;<span style=\"color:#6897bb;\">200</span>)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;console.<span style=\"color:#ffc66d;\">log</span>(resp)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;}<span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function&#32;</span>(resp)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">if</span>(resp.<span style=\"color:#9876aa;\">status&#32;</span>==&#32;<span style=\"color:#6897bb;\">500</span>){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#808080;\">//&#32;上传错误<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;console.<span style=\"color:#ffc66d;\">log</span>(<span style=\"color:#6a8759;\">'Error&#32;:&#32;'&#32;</span>+&#32;resp.<span style=\"color:#9876aa;\">data</span>.<span style=\"color:#9876aa;\">message</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\"><br></span><span style=\"color:#9876aa;\">$scope</span>.<span style=\"color:#ffc66d;\">testUpload&#32;</span>=&#32;<span style=\"color:#cc7832;font-weight:bold;\">function</span>()&#32;{<br>&#32;&#32;&#32;&#32;$(<span style=\"color:#6a8759;\">'#upload-file'</span>).<span style=\"color:#ffc66d;\">click</span>()<span style=\"color:#cc7832;\">;<br></span>}<span style=\"color:#cc7832;\">;</span></pre>]@ \\\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@b</span>-nodejs\n<span contenteditable=\"false\" style=\"color: rgb(0, 192, 255);\">@pre</span>-@[<pre style=\"background-color:#2b2b2b;color:#a9b7c6;font-family:'宋体';font-size:10.5pt;\"><span style=\"color:#9876aa;\">testUpload</span>:&#32;<span style=\"color:#ffc66d;font-weight:bold;\">function</span>(req<span style=\"color:#cc7832;\">,&#32;</span>res)&#32;{<br>&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>upstrem&#32;=&#32;req.<span style=\"color:#9876aa;\">file</span>(<span style=\"color:#6a8759;\">'file'</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;</span>upstrem.<span style=\"color:#9876aa;\">upload</span>(<span style=\"color:#cc7832;font-weight:bold;\">function</span>(err<span style=\"color:#cc7832;\">,&#32;</span>uploadedFiles)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">for&#32;</span>(<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>i&#32;=&#32;<span style=\"color:#6897bb;\">0</span><span style=\"color:#cc7832;\">;&#32;</span>i&#32;&lt;&#32;uploadedFiles.<span style=\"color:#9876aa;\">length</span><span style=\"color:#cc7832;\">;&#32;</span>i++)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>file&#32;=&#32;uploadedFiles[i]<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>fileName&#32;=&#32;file.<span style=\"color:#9876aa;\">filename</span><span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#808080;\">//&#32;var&#32;suffix&#32;=&#32;fileName.substring(fileName.lastIndexOf('.'));<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;var&#32;fileName&#32;=&#32;'test-'&#32;+&#32;new&#32;Date().getTime()&#32;+&#32;suffix;<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>readerStream&#32;=&#32;fs.<span style=\"color:#ffc66d;\">createReadStream</span>(file.<span style=\"color:#9876aa;\">fd</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">var&#32;</span>buffer&#32;=&#32;[]<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>readerStream.<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'data'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(chunk)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;buffer.<span style=\"color:#ffc66d;\">push</span>(chunk)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>readerStream.<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'end'</span><span style=\"color:#cc7832;\">,</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(){<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;buffer&#32;=&#32;Buffer.<span style=\"color:#ffc66d;\">concat</span>(buffer)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#808080;\">//&#32;使用proxy请求文件服务器（这里使用require(restler)）<br></span><span style=\"color:#808080;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>restler.<span style=\"color:#9876aa;\">post</span>(<span style=\"color:#6a8759;\">'http://127.0.0.1:3000/api/upload/'</span><span style=\"color:#cc7832;\">,&#32;</span>{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#9876aa;\">data</span>:&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<span style=\"color:#9876aa;\">filePath</span>:&#32;req.allParams().<span style=\"color:#9876aa;\">filePath</span><span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">fileName</span>:&#32;file.<span style=\"color:#9876aa;\">filename</span><span style=\"color:#cc7832;\">,<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span><span style=\"color:#9876aa;\">fileBuffer</span>:&#32;buffer.<span style=\"color:#ffc66d;\">toString</span>(<span style=\"color:#6a8759;\">'hex'</span>)<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}).<span style=\"color:#ffc66d;\">on</span>(<span style=\"color:#6a8759;\">'complete'</span><span style=\"color:#cc7832;\">,&#32;</span><span style=\"color:#cc7832;font-weight:bold;\">function</span>(ret)&#32;{<br>&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;res.<span style=\"color:#ffc66d;\">ok</span>(ret.<span style=\"color:#9876aa;\">data</span>)<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>})<span style=\"color:#cc7832;\">;<br></span><span style=\"color:#cc7832;\">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</span>}<br>&#32;&#32;&#32;&#32;})<br>}</pre>]@ \\\n\n\n<span style=\"font-style: italic; color: #00c0ff;\" contenteditable=\"false\" class=\"\">@h2</span>-测试URL\n首页文件列表（端口可能不一样） http://localhost:3002\n资源预览（../assets/xxx/xx）  http://localhost:3002/assets/1/1.jpg\n资源下载（../download/assets/xxx/xx)  http://localhost:3002/download/assets/1/1.jpg\n\n",
  "noteName": "2017-3-22"
}